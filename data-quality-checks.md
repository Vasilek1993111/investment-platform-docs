# Функции и процедуры для сверок и алертов

## Обзор

Данный документ описывает функции и процедуры базы данных, предназначенные для проверки качества данных, выявления несоответствий и генерации алертов. Эти функции используются для обеспечения целостности и корректности данных в системе.

---

## Функции проверки качества данных

### 1. `invest_candles.run_daily_vs_minute_check(p_date DATE)`

**Схема:** `invest_candles` (доступ через `invest.run_daily_vs_minute_check`)  
**Тип:** FUNCTION  
**Возвращает:** TABLE(task_id TEXT, total_rows BIGINT, mismatches BIGINT)

**Описание:** Оптимизированная функция для проверки соответствия дневных свечей агрегированным минутным свечам за указанную дату. Выполняет валидацию качества данных, сравнивая агрегированные значения из минутных свечей с дневными свечами.

**Параметры:**
- `p_date` (DATE) - Дата для проверки (в московском времени)

**Возвращаемые значения:**
- `task_id` (TEXT) - Уникальный идентификатор задачи проверки
- `total_rows` (BIGINT) - Общее количество проверенных записей
- `mismatches` (BIGINT) - Количество найденных несоответствий

**Логика работы:**

1. **Определение типа дня:**
   - Определяет, является ли день выходным (суббота/воскресенье)
   - Используется для выбора правильных торговых часов

2. **Получение дневных свечей:**
   - Извлекает дневные свечи из `invest.daily_candles` за указанную дату
   - Определяет тип инструмента (shares/futures) через JOIN с таблицами `shares` и `futures`
   - Фильтрует только акции и фьючерсы

3. **Получение торговых часов:**
   - Для каждого инструмента получает специальные торговые часы из `invest_candles.special_trading_hours`
   - Если специальных часов нет, использует стандартные:
     - Выходные дни: 09:59-18:59 MSK
     - Рабочие дни: 00:00-23:59 MSK (без ограничений)

4. **Агрегация минутных свечей:**
   - Агрегирует минутные свечи из `invest.minute_candles` за указанную дату
   - Учитывает торговые часы для каждого инструмента
   - Вычисляет:
     - `minute_volume` - сумма объемов
     - `minute_high` - максимальная цена
     - `minute_low` - минимальная цена
     - `minute_open` - цена открытия (первая свеча)
     - `minute_close` - цена закрытия (последняя свеча)

5. **Сравнение данных:**
   - Сравнивает дневные и агрегированные минутные данные
   - Проверяет несоответствия с допустимыми погрешностями:
     - Volume: ±1
     - Цены (high, low, open, close): ±0.01

6. **Запись результатов:**
   - Записывает все найденные проблемы в таблицу `invest_utils.data_quality_issues` одним batch-запросом
   - Логирует результаты выполнения в `invest.system_logs`

**Оптимизации:**

- **Замена цикла на JOIN:** Вместо цикла по каждой дневной свече используется один большой JOIN-запрос с CTE
- **Batch inserts:** Все проблемы записываются одним `INSERT ... SELECT` вместо отдельных вставок
- **Оптимизация торговых часов:** Использование `LATERAL JOIN` для эффективного получения торговых часов
- **Предварительная агрегация:** Минутные свечи агрегируются одним запросом для всех инструментов

**Производительность:**

- **До оптимизации:** > 10 минут для 538 дневных свечей (2000+ запросов)
- **После оптимизации:** < 30 секунд (5-10 запросов)
- **Улучшение:** в 20+ раз

**Требуемые индексы:**

Для оптимальной производительности требуются индексы:
- `idx_daily_candles_date` на `invest_candles.daily_candles(date(time at time zone 'Europe/Moscow'))`
- `idx_minute_candles_date` на `invest_candles.minute_candles(date(time at time zone 'Europe/Moscow'))`
- `idx_special_trading_hours_figi_active` на `invest_candles.special_trading_hours(figi, is_active, day_type) WHERE is_active = true`

**Пример использования:**
```sql
-- Проверка данных за конкретную дату
SELECT * FROM invest_candles.run_daily_vs_minute_check('2026-01-22'::date);

-- Или через обертку в схеме invest
SELECT * FROM invest.run_daily_vs_minute_check('2026-01-22'::date);
```

**Результат:**
```
task_id                              | total_rows | mismatches
-------------------------------------+------------+------------
daily_vs_minute_check_2026_01_22_... | 538        | 12
```

**Просмотр найденных проблем:**
```sql
-- Получить детали проблем для конкретной задачи
SELECT * FROM invest_utils.data_quality_issues 
WHERE task_id = 'daily_vs_minute_check_2026_01_22_...'
ORDER BY status DESC, created_at DESC;
```

**Примечания:**

- Функция учитывает только акции и фьючерсы (исключает индикативы)
- Учитывает специальные торговые часы для инструментов
- Различает рабочие и выходные дни для корректного определения торговых часов
- Все временные метки обрабатываются в московском времени (`Europe/Moscow`)

---

## Таблица результатов проверок

### `invest_utils.data_quality_issues`

Таблица для хранения результатов проверок качества данных.

**Основные поля:**
- `task_id` - Идентификатор задачи проверки
- `check_name` - Название проверки (например, 'daily_vs_minute_check')
- `entity_type` - Тип сущности (shares/futures)
- `entity_id` - FIGI инструмента
- `trade_date` - Дата торгов
- `metric` - Метрика проверки
- `status` - Статус (ERROR/WARNING)
- `message` - Сообщение о проблеме
- `expected_numeric` - Ожидаемое значение
- `actual_numeric` - Фактическое значение
- `diff_numeric` - Разница
- `details` - Дополнительные детали в формате JSONB

---

## Рекомендации по использованию

### Автоматизация проверок

1. **Планировщик задач:**
   - Настроить регулярный запуск проверок (например, ежедневно после закрытия торгов)
   - Использовать cron или pg_cron для автоматизации

2. **Мониторинг:**
   - Настроить алерты при обнаружении критических несоответствий (status = 'ERROR')
   - Регулярно проверять таблицу `data_quality_issues` на наличие проблем

3. **Анализ результатов:**
   - Анализировать паттерны несоответствий для выявления системных проблем
   - Отслеживать тренды качества данных

### Оптимизация производительности

1. **Индексы:**
   - Убедиться, что все требуемые индексы созданы
   - Регулярно выполнять `VACUUM ANALYZE` на таблицах с данными

2. **Партиционирование:**
   - Рассмотреть партиционирование таблицы `data_quality_issues` по дате для быстрого доступа к историческим данным

3. **Очистка старых данных:**
   - Регулярно удалять старые записи из `data_quality_issues` (например, старше 90 дней)

---

## Связанные документы

- [db-objects.md](./db-objects.md) - Общее описание объектов базы данных
- [db-logical-model.md](./db-logical-model.md) - Логическая модель базы данных
