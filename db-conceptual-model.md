# Концептуальная модель базы данных InvestmentDataLoaderService

## 1. Обзор системы

База данных предназначена для хранения и анализа данных о финансовых инструментах (акции, фьючерсы, индикативы) с биржи Tinkoff Invest API. Система обеспечивает:

- Загрузку и хранение справочной информации об инструментах
- Сбор исторических и текущих ценовых данных
- Анализ свечных паттернов и технических индикаторов
- Бэктестинг торговых стратегий
- Мониторинг качества данных
- Агрегацию торговых объемов

---

## 2. Бизнес-сущности (Концептуальный уровень)

### 2.1. Финансовые инструменты

#### 2.1.1. Акция (Share)
**Описание:** Долевая ценная бумага, представляющая долю собственности в компании.

**Основные характеристики:**
- Уникальный идентификатор (FIGI)
- Тикер и название компании
- Биржа и валюта торговли
- Сектор экономики
- Статус торговли
- Возможность коротких продаж
- Параметры торговли (лот, минимальный шаг цены)

**Бизнес-правила:**
- Каждая акция имеет уникальный FIGI
- Акция может торговаться на разных биржах (разные FIGI)
- Статус торговли может изменяться (торгуется, приостановлена, закрыта)

#### 2.1.2. Фьючерс (Future)
**Описание:** Производный финансовый инструмент, контракт на покупку/продажу базового актива в будущем.

**Основные характеристики:**
- Уникальный идентификатор (FIGI)
- Тикер и тип базового актива
- Базовый актив (акция, индекс, товар, валюта)
- Валюта и биржа
- Дата экспирации
- Размер базового актива
- Возможность коротких продаж
- Параметры торговли (лот, минимальный шаг цены)

**Бизнес-правила:**
- Фьючерс имеет ограниченный срок жизни (до экспирации)
- Базовый актив определяет поведение цены фьючерса
- После экспирации фьючерс перестает торговаться

#### 2.1.3. Индикатив (Indicative)
**Описание:** Индикативный инструмент, используемый для расчетов и индексов.

**Основные характеристики:**
- FIGI, тикер, название
- Валюта и биржа
- Код класса инструмента
- Флаги доступности для покупки/продажи

---

### 2.2. Фундаментальные данные

#### 2.2.1. Фундаментальные показатели (Fundamentals)
**Описание:** Финансовые метрики компании, используемые для оценки инвестиционной привлекательности.

**Категории показателей:**

1. **Дивидендные показатели:**
   - Дивидендная доходность (TTM, прогнозная, средняя за 5 лет)
   - Ставка дивиденда
   - Коэффициент выплаты дивидендов
   - Дивиденды на акцию
   - Темп роста дивидендов

2. **Показатели оценки:**
   - P/E (цена/прибыль)
   - P/B (цена/балансовая стоимость)
   - P/S (цена/выручка)
   - EV/EBITDA (стоимость предприятия/EBITDA)
   - P/FCF (цена/свободный денежный поток)

3. **Показатели прибыльности:**
   - EPS (прибыль на акцию)
   - Чистая прибыль
   - EBITDA
   - Выручка
   - Чистая маржа

4. **Показатели рентабельности:**
   - ROE (рентабельность собственного капитала)
   - ROA (рентабельность активов)
   - ROIC (рентабельность инвестированного капитала)

5. **Показатели роста:**
   - Темпы роста выручки (1, 3, 5 лет)
   - Изменение прибыли за 5 лет
   - Изменение EBITDA за 5 лет

6. **Показатели долга:**
   - Общий долг
   - Отношение долга к капиталу
   - Отношение долга к EBITDA
   - Чистый долг

7. **Показатели ликвидности:**
   - Коэффициент текущей ликвидности
   - Покрытие фиксированных платежей
   - Чистая процентная маржа

8. **Рыночные показатели:**
   - Рыночная капитализация
   - Стоимость предприятия
   - Количество акций в обращении
   - Свободно обращающиеся акции (free float)
   - Бета-коэффициент

9. **Ценовые показатели:**
   - Максимальная/минимальная цена за 52 недели

10. **Объемы торгов:**
    - Средний дневной объем за 4 недели
    - Средний дневной объем за 10 дней

**Бизнес-правила:**
- Показатели обновляются периодически (TTM - trailing twelve months, MRQ - most recent quarter, FY - fiscal year)
- Показатели привязаны к финансовому периоду компании
- Разные компании могут иметь разные финансовые периоды

#### 2.2.2. Дивиденды (Dividends)
**Описание:** Выплаты акционерам из прибыли компании.

**Основные характеристики:**
- Инструмент (FIGI)
- Дата объявления дивидендов
- Дата фиксации реестра (record date)
- Дата выплаты (payment date)
- Размер дивиденда на акцию
- Валюта выплаты
- Тип дивиденда (обычный, специальный)

**Бизнес-правила:**
- Дивиденды объявляются до даты фиксации реестра
- Акционеры, владеющие акциями на дату фиксации реестра, получают дивиденды
- Выплата происходит после даты фиксации реестра

---

### 2.3. Ценовые данные

#### 2.3.1. Цена закрытия (Close Price)
**Описание:** Цена закрытия торговой сессии за день.

**Основные характеристики:**
- Инструмент (FIGI)
- Дата торгов
- Цена закрытия
- Валюта
- Биржа
- Тип инструмента

**Бизнес-правила:**
- Одна цена закрытия на инструмент в день
- Данные партиционированы по месяцам для оптимизации
- Цена закрытия используется для расчета доходности

#### 2.3.2. Цена открытия (Open Price)
**Описание:** Цена открытия торговой сессии за день.

**Основные характеристики:**
- Инструмент (FIGI)
- Дата торгов
- Цена открытия
- Валюта
- Биржа
- Тип инструмента

**Бизнес-правила:**
- Одна цена открытия на инструмент в день
- Используется для расчета дневного изменения цены

#### 2.3.3. Последняя цена (Last Price)
**Описание:** Последняя цена сделки по инструменту в реальном времени.

**Основные характеристики:**
- Инструмент (FIGI)
- Время сделки
- Цена
- Валюта
- Биржа

**Бизнес-правила:**
- Обновляется в реальном времени во время торгов
- Может отсутствовать для инструментов, не торгующихся в данный момент

---

### 2.4. Свечные данные

#### 2.4.1. Дневная свеча (Daily Candle)
**Описание:** Агрегированные данные о торговле за торговый день (OHLCV).

**Основные характеристики:**
- Инструмент (FIGI)
- Время (начало дня)
- Open, High, Low, Close (OHLC)
- Объем торгов
- Вычисляемые показатели:
  - Изменение цены (абсолютное и процентное)
  - Тип свечи (бычья, медвежья, доджи)
  - Размер тела, верхняя/нижняя тени
  - Диапазон цен (high - low)
  - Средняя цена

**Бизнес-правила:**
- Одна свеча на инструмент в день
- Свеча считается завершенной после закрытия торговой сессии
- Используется для технического анализа и построения графиков

#### 2.4.2. Минутная свеча (Minute Candle)
**Описание:** Агрегированные данные о торговле за одну минуту (OHLCV).

**Основные характеристики:**
- Инструмент (FIGI)
- Время (начало минуты)
- Open, High, Low, Close (OHLC)
- Объем торгов
- Флаг завершенности свечи
- Вычисляемые показатели (аналогично дневным свечам)

**Бизнес-правила:**
- Множество свечей на инструмент в день (по минутам)
- Текущая свеча может быть незавершенной
- Используется для внутридневного анализа и алгоритмической торговли
- Данные партиционированы по дням для оптимизации

---

### 2.5. Торговые данные

#### 2.5.1. Сделка (Trade)
**Описание:** Отдельная сделка по инструменту.

**Основные характеристики:**
- Инструмент (FIGI)
- Время сделки
- Цена
- Количество (объем)
- Направление сделки (покупка/продажа)
- Валюта
- Биржа
- Источник данных

**Бизнес-правила:**
- Сделки регистрируются в реальном времени
- Используются для построения свечей и анализа объемов
- Могут быть агрегированы в свечи

#### 2.5.2. Заявка (Order)
**Описание:** Заявка на покупку/продажу инструмента (если используется).

**Примечание:** Структура таблицы требует дополнительного анализа.

---

### 2.6. Аналитические данные

#### 2.6.1. Анализ свечных паттернов (Candle Pattern Analysis)
**Описание:** Результаты анализа свечных паттернов для выявления торговых возможностей.

**Основные характеристики:**
- Инструмент (FIGI)
- Дата анализа
- Выявленные паттерны (например, падение 5+ дней подряд)
- Рекомендации по торговле

**Бизнес-правила:**
- Анализ выполняется автоматически по расписанию
- Используется для стратегии продолжения тренда
- Исключает праздники и выходные дни

#### 2.6.2. Результаты бэктестинга (Backtest Results)
**Описание:** Результаты тестирования торговых стратегий на исторических данных.

**Основные характеристики:**
- Связь с анализом паттернов
- Инструмент (FIGI)
- Дата входа в позицию
- Тип входа (LONG/SHORT)
- Цена входа
- Объем позиции
- Параметры стоп-лосса и тейк-профита
- Тип выхода (стоп-лосс, тейк-профит, время)
- Цена выхода
- Результат (прибыль/убыток)
- Длительность позиции

**Бизнес-правила:**
- Бэктестинг выполняется на исторических данных
- Позволяет оценить эффективность стратегии до реальной торговли
- Учитывает комиссии и проскальзывания

#### 2.6.3. Исторические экстремумы цен (Historical Price Extremes)
**Описание:** Зафиксированные максимальные и минимальные цены за определенные периоды.

**Примечание:** Требует дополнительного анализа структуры.

---

### 2.7. Агрегированные данные

#### 2.7.1. Агрегированные данные по акциям (Shares Aggregated Data)
**Описание:** Предрасчитанные агрегации по акциям для ускорения запросов.

**Примечание:** Требует дополнительного анализа структуры.

#### 2.7.2. Агрегированные данные по фьючерсам (Futures Aggregated Data)
**Описание:** Предрасчитанные агрегации по фьючерсам для ускорения запросов.

**Примечание:** Требует дополнительного анализа структуры.

#### 2.7.3. Агрегация объемов (Volume Aggregation)
**Описание:** Агрегированные данные об объемах торгов по различным периодам и сессиям.

**Основные характеристики:**
- Инструмент (FIGI)
- Дата торгов
- Объемы по сессиям (утренняя, основная, вечерняя)
- Средние объемы
- Количество свечей

**Бизнес-правила:**
- Агрегация выполняется автоматически
- Используется для анализа ликвидности
- Разделение по торговым сессиям (MOEX имеет несколько сессий)

---

### 2.8. Служебные данные

#### 2.8.1. Системные логи (System Logs)
**Описание:** Логирование работы системы и методов загрузки данных.

**Основные характеристики:**
- ID задачи
- Эндпоинт API
- HTTP метод
- Статус выполнения
- Сообщение
- Время начала/завершения
- Длительность выполнения

**Бизнес-правила:**
- Используется для мониторинга и отладки
- Помогает выявить проблемы с загрузкой данных

#### 2.8.2. Проблемы качества данных (Data Quality Issues)
**Описание:** Зафиксированные проблемы с качеством данных (несоответствия, пропуски).

**Примечание:** Требует дополнительного анализа структуры.

#### 2.8.3. Специальные торговые часы (Special Trading Hours)
**Описание:** Информация о специальных торговых сессиях (праздники, сокращенные дни).

**Примечание:** Требует дополнительного анализа структуры.

---

## 3. Связи между сущностями

### 3.1. Основные связи

1. **Инструмент → Ценовые данные**
   - Один инструмент имеет множество цен закрытия/открытия
   - Связь через FIGI

2. **Инструмент → Свечи**
   - Один инструмент имеет множество дневных и минутных свечей
   - Связь через FIGI

3. **Инструмент → Фундаментальные данные**
   - Один инструмент имеет один набор фундаментальных показателей
   - Связь через FIGI

4. **Инструмент → Дивиденды**
   - Один инструмент может иметь множество дивидендных событий
   - Связь через FIGI

5. **Инструмент → Сделки**
   - Один инструмент имеет множество сделок
   - Связь через FIGI

6. **Анализ паттернов → Бэктестинг**
   - Один анализ паттернов может иметь множество результатов бэктестинга
   - Связь через pattern_analysis_id

7. **Свечи → Агрегации**
   - Свечи агрегируются в различные представления объемов
   - Связь через FIGI и время

---

## 4. Архитектурные особенности

### 4.1. Партиционирование

Система использует партиционирование для оптимизации работы с большими объемами данных:

- **Цены закрытия:** партиционирование по месяцам
- **Минутные свечи:** партиционирование по дням
- **Дневные свечи:** партиционирование по месяцам
- **MT5 таблицы:** партиционирование по месяцам/дням

### 4.2. Схемы базы данных

База данных организована в несколько схем:

- **invest_ref:** справочники (акции, фьючерсы, дивиденды, фундаментальные данные)
- **invest_prices:** ценовые данные
- **invest_candles:** свечные данные
- **invest_utils:** служебные таблицы и функции
- **invest:** основная схема с представлениями (views) для удобства доступа

### 4.3. Представления (Views)

Для удобства доступа созданы представления в схеме `invest`, которые являются синонимами таблиц из других схем. Это обеспечивает единообразный интерфейс доступа к данным.

---

## 5. Бизнес-процессы

### 5.1. Загрузка данных

1. **Загрузка справочников:** периодическое обновление списка инструментов
2. **Загрузка цен:** ежедневная загрузка цен закрытия/открытия
3. **Загрузка свечей:** непрерывная загрузка минутных свечей в реальном времени
4. **Загрузка фундаментальных данных:** периодическое обновление показателей компаний
5. **Загрузка дивидендов:** обновление при объявлении новых дивидендов

### 5.2. Анализ данных

1. **Анализ паттернов:** автоматический анализ свечных паттернов по расписанию
2. **Бэктестинг:** тестирование стратегий на исторических данных
3. **Агрегация:** предрасчет агрегированных показателей для ускорения запросов
4. **Контроль качества:** проверка целостности и качества данных

### 5.3. Торговые стратегии

1. **Стратегия продолжения тренда:** на основе анализа паттернов падения/роста
2. **Mean Reversion:** стратегия возврата к среднему (bt_mean_reversion_trades)

---

## 6. Ключевые метрики и показатели

### 6.1. Технические индикаторы

- Изменение цены (абсолютное и процентное)
- Тип свечи (бычья/медвежья/доджи)
- Размер тела и теней свечи
- Объемы торгов
- Средние цены

### 6.2. Фундаментальные показатели

- Множество финансовых коэффициентов (см. раздел 2.2.1)
- Дивидендная доходность
- Рентабельность
- Показатели роста
- Показатели долга

### 6.3. Торговые метрики

- Прибыль/убыток по сделкам
- Длительность позиций
- Процент успешных сделок
- Средняя прибыль/убыток

---

## 7. Ограничения и бизнес-правила

1. **Уникальность данных:**
   - Одна цена закрытия/открытия на инструмент в день
   - Одна дневная свеча на инструмент в день
   - Одна минутная свеча на инструмент в минуту

2. **Временные ограничения:**
   - Данные привязаны к московскому времени (Europe/Moscow)
   - Учитываются торговые сессии биржи

3. **Качество данных:**
   - Проверка соответствия объемов дневных и минутных свечей
   - Выявление экстремальных значений цен
   - Логирование проблем качества данных

4. **Партиционирование:**
   - Партиции создаются автоматически через функции
   - Старые партиции могут архивироваться

---

## 8. Следующие шаги

Для полной документации необходимо:

1. **Логическая модель:** детальное описание таблиц, атрибутов, ключей, индексов
2. **Физическая модель:** описание партиционирования, индексов, оптимизаций
3. **Диаграммы:** ER-диаграммы, диаграммы потоков данных
4. **API документация:** описание эндпоинтов для доступа к данным
5. **Примеры запросов:** типовые SQL-запросы для различных сценариев использования
